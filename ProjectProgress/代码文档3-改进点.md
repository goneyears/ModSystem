# Unityæ¨¡ç»„ç³»ç»Ÿä»£ç æ–‡æ¡£æ”¹è¿›æ¸…å•

## æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“äº†ä»£ç å®¡æŸ¥ä¸­å‘ç°çš„æ¶æ„è®¾è®¡é—®é¢˜å’Œæ”¹è¿›å»ºè®®ï¼Œç”¨äºæŒ‡å¯¼é¡¹ç›®çŸ¥è¯†åº“çš„æ›´æ–°ã€‚

## 1. æ¶æ„å±‚æ¬¡é—®é¢˜

### 1.1 Coreå±‚Unityä¾èµ–é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
- `ModLoader.cs` å’Œ `ModManager.cs` åœ¨Coreå±‚ä¸­ä½¿ç”¨äº† `UnityEngine`
- è¿åäº†Coreå±‚åº”è¯¥æ˜¯å¹³å°æ— å…³çš„è®¾è®¡åŸåˆ™
- å¯¼è‡´ModSDKæ— æ³•çœŸæ­£ç‹¬ç«‹äºUnity

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š

#### Coreå±‚ä½¿ç”¨æŠ½è±¡æ¥å£
```csharp
// ModSystem.Core/Interfaces/ILogger.cs
namespace ModSystem.Core
{
    public interface ILogger
    {
        void Log(string message);
        void LogWarning(string message);
        void LogError(string message);
    }
}

// ModSystem.Core/Interfaces/IPathProvider.cs
namespace ModSystem.Core
{
    public interface IPathProvider
    {
        string GetModsPath();
        string GetConfigPath();
        string GetTempPath();
    }
}
```

#### ModLoaderæ”¹è¿›
```csharp
// ModSystem.Core/Runtime/ModLoader.cs
// ç§»é™¤: using UnityEngine;
namespace ModSystem.Core
{
    public class ModLoader
    {
        private readonly ILogger logger;
        private readonly IPathProvider pathProvider;
        
        public ModLoader(ILogger logger, IPathProvider pathProvider, SecurityManager securityManager = null)
        {
            this.logger = logger;
            this.pathProvider = pathProvider;
            // ...
        }
    }
}
```

#### Unityå±‚æä¾›å®ç°
```csharp
// ModSystem.Unity/UnityLogger.cs
using UnityEngine;
using ModSystem.Core;

namespace ModSystem.Unity
{
    public class UnityLogger : ILogger
    {
        public void Log(string message) => Debug.Log(message);
        public void LogWarning(string message) => Debug.LogWarning(message);
        public void LogError(string message) => Debug.LogError(message);
    }
}
```

### 1.2 ModSystemControllerä½ç½®é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
- `ModSystemController.cs` åœ¨é¡¹ç›®ç»“æ„ä¸­æ²¡æœ‰æ˜ç¡®æ ‡æ³¨ä½ç½®
- ä½œä¸ºUnityç‰¹å®šçš„é›†æˆä»£ç ï¼Œä¸åº”è¯¥åœ¨Coreä¸­

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
```
UnityProject/
â”œâ”€â”€ Assets/
â”‚   â”œâ”€â”€ ModSystem/
â”‚   â”‚   â”œâ”€â”€ Core/               # å¹³å°æ— å…³ä»£ç 
â”‚   â”‚   â”‚   â””â”€â”€ Assemblies/     # Core DLLæ”¾ç½®ä½ç½®
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ Unity/              # Unityç‰¹å®šä»£ç 
â”‚   â”‚       â”œâ”€â”€ ModSystemController.cs    â† æ­£ç¡®ä½ç½®
â”‚   â”‚       â”œâ”€â”€ ModManager.cs             # MonoBehaviouråŒ…è£…å™¨
â”‚   â”‚       â”œâ”€â”€ UnityLogger.cs            # Unityå®ç°
â”‚   â”‚       â””â”€â”€ Editor/
â”‚   â”‚           â””â”€â”€ ModSystemEditor.cs
```

## 2. æ¨¡ç»„åˆå§‹åŒ–é‡å¤é—®é¢˜

### 2.1 behaviour.OnInitializeé‡å¤è°ƒç”¨

**é—®é¢˜æè¿°**ï¼š
- ObjectFactoryä¸­çš„ `ConfigureModBehaviour` ä¼šè°ƒç”¨ `OnInitialize`
- ModManagerä¸­çš„ `CreateModInstance` ä¹Ÿä¼šè°ƒç”¨ `OnInitialize`
- å¯¼è‡´åŒä¸€ä¸ªè¡Œä¸ºå¯èƒ½è¢«åˆå§‹åŒ–ä¸¤æ¬¡

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š

#### æ–¹æ¡ˆAï¼šObjectFactoryä¸è´Ÿè´£åˆå§‹åŒ–
```csharp
// ModSystem.Core/Runtime/ObjectFactory.cs
private void ConfigureModBehaviour(GameObject obj, ComponentDefinition compDef)
{
    var behaviourClass = compDef.GetProperty<string>("behaviourClass");
    
    // åªåˆ›å»ºåŒ…è£…å™¨ï¼Œä¸åˆå§‹åŒ–è¡Œä¸º
    var wrapper = obj.AddComponent<ModBehaviourWrapper>();
    wrapper.BehaviourClass = behaviourClass;
    wrapper.Config = compDef.GetProperty<Dictionary<string, object>>("config");
    wrapper.AutoInitialize = false;  // æ ‡è®°ä¸è‡ªåŠ¨åˆå§‹åŒ–
}
```

#### æ–¹æ¡ˆBï¼šåŒºåˆ†ä¸åŒç±»å‹çš„è¡Œä¸º
```csharp
// ä¸»æ¨¡ç»„è¡Œä¸ºï¼ˆç”±ModManagerç®¡ç†ï¼‰
public interface IModBehaviour
{
    void OnInitialize(IModContext context);
}

// å¯¹è±¡é™„åŠ è¡Œä¸ºï¼ˆç”±ObjectFactoryç®¡ç†ï¼‰
public interface IObjectBehaviour
{
    void OnAttach(GameObject gameObject);
    void OnConfigure(Dictionary<string, object> config);
}
```

## 3. ModBuilderæ¨¡æ¿ç³»ç»Ÿæ”¹è¿›

### 3.1 ç¡¬ç¼–ç é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
- ModBuilderä¸­ç¡¬ç¼–ç äº†ButtonModã€RobotModç­‰ç‰¹å®šæ¨¡ç»„ç±»å‹
- æ·»åŠ æ–°æ¨¡ç»„ç±»å‹éœ€è¦ä¿®æ”¹ModBuilderä»£ç 
- è¿åå¼€é—­åŸåˆ™

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š

#### åŸºäºæ¨¡æ¿çš„ç³»ç»Ÿ
```
ModSDK/
â”œâ”€â”€ Templates/
â”‚   â”œâ”€â”€ ButtonMod/
â”‚   â”‚   â”œâ”€â”€ template.json              # æ¨¡æ¿å…ƒæ•°æ®
â”‚   â”‚   â”œâ”€â”€ Source/
â”‚   â”‚   â”‚   â””â”€â”€ {{ModName}}Behaviour.cs.template
â”‚   â”‚   â””â”€â”€ manifest.json.template
â”‚   â”‚
â”‚   â””â”€â”€ UserTemplates/                 # ç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿
```

#### æ¨¡æ¿å…ƒæ•°æ®
```json
{
  "id": "button_mod_template",
  "name": "æŒ‰é’®æ¨¡ç»„æ¨¡æ¿",
  "variables": [
    {
      "name": "ModId",
      "type": "string",
      "required": true
    }
  ],
  "files": [
    {
      "template": "Source/{{ModName}}Behaviour.cs.template",
      "output": "Source/{{PascalCase ModName}}Behaviour.cs"
    }
  ]
}
```

#### åŠ¨æ€æ¨¡æ¿åŠ è½½
```csharp
public class ModBuilder
{
    public List<ModTemplate> GetAvailableTemplates()
    {
        var templates = new List<ModTemplate>();
        
        foreach (var templateDir in Directory.GetDirectories(templatesPath))
        {
            var templateFile = Path.Combine(templateDir, "template.json");
            if (File.Exists(templateFile))
            {
                var template = JsonSerializer.Deserialize<ModTemplate>(
                    File.ReadAllText(templateFile)
                );
                templates.Add(template);
            }
        }
        
        return templates;
    }
}
```

## 4. æ–‡æ¡£ç»“æ„æ”¹è¿›

### 4.1 ç« èŠ‚é¡ºåºé—®é¢˜

**é—®é¢˜æè¿°**ï¼š
- ModLoaderå’ŒModManagerä½œä¸ºæ ¸å¿ƒç»„ä»¶å´æ”¾åœ¨"æ”¯æŒç³»ç»Ÿå®ç°"ç« èŠ‚
- è¯»è€…éœ€è¦å…ˆç†è§£è¿™äº›ç»„ä»¶æ‰èƒ½ç†è§£ç³»ç»Ÿè¿ä½œ
- "æ”¯æŒç³»ç»Ÿ"å‘½åè¯¯å¯¼

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š

```
å»ºè®®çš„æ–‡æ¡£ç»“æ„ï¼š
1. ç³»ç»Ÿæ¦‚è¿°
2. é¡¹ç›®ç»“æ„
3. æ ¸å¿ƒç»„ä»¶
   3.1 åŸºç¡€æ¥å£å®šä¹‰
   3.2 è¿è¡Œæ—¶æ ¸å¿ƒç»„ä»¶
       - ModSystemControllerï¼ˆUnityé›†æˆæ§åˆ¶å™¨ï¼‰
       - ModManagerï¼ˆæ¨¡ç»„ç®¡ç†å™¨ï¼‰
       - ModLoaderï¼ˆæ¨¡ç»„åŠ è½½å™¨ï¼‰
       - ObjectFactoryï¼ˆå¯¹è±¡å·¥å‚ï¼‰
   3.3 é€šä¿¡ç³»ç»Ÿ
       - EventBusï¼ˆäº‹ä»¶æ€»çº¿ï¼‰
       - RequestResponseï¼ˆè¯·æ±‚å“åº”ï¼‰
       - ServiceRegistryï¼ˆæœåŠ¡æ³¨å†Œï¼‰
   3.4 å®‰å…¨ç³»ç»Ÿ
       - SecurityManager
4. é€šä¿¡æ¨¡å¼è¯¦è§£
5. æ¨¡ç»„å¼€å‘
6. é…ç½®ç³»ç»Ÿ
7. éƒ¨ç½²å’Œå®‰è£…
8. è°ƒè¯•å’Œä¼˜åŒ–
```

## 5. å¼€å‘ç¯å¢ƒè¯´æ˜è¡¥å……

### 5.1 æ–‡ä»¶å½’å±ä¸æ¸…æ™°

**é—®é¢˜æè¿°**ï¼š
- æ–‡æ¡£ä¸­æ²¡æœ‰æ˜ç¡®è¯´æ˜å“ªäº›æ–‡ä»¶åœ¨Unityä¸­å¼€å‘ï¼Œå“ªäº›åœ¨VSä¸­ç‹¬ç«‹å¼€å‘
- å®¹æ˜“é€ æˆå¼€å‘è€…å›°æƒ‘

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š

æ·»åŠ å¼€å‘ç¯å¢ƒåˆ†ç±»è¯´æ˜ï¼š

#### Unityç¼–è¾‘å™¨ä¸­å¼€å‘ï¼ˆğŸ”µï¼‰
- ç»§æ‰¿MonoBehaviourçš„ç±»
- ä½¿ç”¨Unityç‰¹å®šAPIçš„ä»£ç 
- Unity Editoræ‰©å±•
- åœºæ™¯æ–‡ä»¶

#### Visual Studioç‹¬ç«‹å¼€å‘ï¼ˆğŸŸ¢ï¼‰
- Coreç³»ç»Ÿï¼ˆç¼–è¯‘æˆDLLï¼‰
- æ¨¡ç»„ä»£ç ï¼ˆä½¿ç”¨ModSDKï¼‰
- ä¸ä¾èµ–Unityçš„çº¯C#ä»£ç 

#### æ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆğŸŸ¡ï¼‰
- JSONé…ç½®æ–‡ä»¶
- å¯¹è±¡å®šä¹‰æ–‡ä»¶
- æ¨¡ç»„æ¸…å•æ–‡ä»¶

## 6. å…¨å±€ç®¡ç†å™¨è¯´æ˜

### 6.1 æ¦‚å¿µä¸æ¸…æ™°

**é—®é¢˜æè¿°**ï¼š
- ModContextæ„é€ å‡½æ•°ä¸­æ³¨é‡Š"å…¶ä»–å±æ€§åº”è¯¥ä»å…¨å±€ç®¡ç†å™¨è·å–"ä¸æ˜ç¡®
- æ²¡æœ‰è§£é‡Šä»€ä¹ˆæ˜¯å…¨å±€ç®¡ç†å™¨

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š

æ·»åŠ æ˜ç¡®è¯´æ˜ï¼š
- **å…¨å±€ç®¡ç†å™¨**æŒ‡ModSystemControllerå’ŒModManagerçš„ç»„åˆ
- è´Ÿè´£ç®¡ç†å…±äº«èµ„æºï¼šEventBusã€ServiceRegistryã€SecurityManagerç­‰
- æ‰€æœ‰æ¨¡ç»„é€šè¿‡Contextè®¿é—®è¿™äº›å…±äº«èµ„æº

## 7. ä»£ç ç¤ºä¾‹æ”¹è¿›

### 7.1 ModManageråˆ†ç¦»

**æ”¹è¿›å‰**ï¼š
```csharp
// ModSystem.Core/Runtime/ModManager.cs
public class ModManager : MonoBehaviour  // âŒ Coreä¸­ä¸åº”è¯¥æœ‰MonoBehaviour
```

**æ”¹è¿›å**ï¼š
```csharp
// ModSystem.Core/Runtime/ModManagerCore.cs
public class ModManagerCore  // âœ… çº¯C#ç±»
{
    // æ ¸å¿ƒé€»è¾‘
}

// ModSystem.Unity/ModManager.cs
public class ModManager : MonoBehaviour  // âœ… UnityåŒ…è£…å™¨
{
    private ModManagerCore core;
    // Unityç‰¹å®šåŠŸèƒ½
}
```

## 8. é¡¹ç›®ç»“æ„å®Œå–„

### 8.1 å®Œæ•´çš„é¡¹ç›®ç»“æ„

```
å·¥ä½œåŒº/
â”œâ”€â”€ ModSystemCore/              # VSç‹¬ç«‹é¡¹ç›®
â”‚   â”œâ”€â”€ ModSystem.Core.sln
â”‚   â”œâ”€â”€ Interfaces/
â”‚   â”œâ”€â”€ Runtime/
â”‚   â””â”€â”€ bin/Release/
â”‚       â””â”€â”€ ModSystem.Core.dll  â†’ å¤åˆ¶åˆ°Unity
â”‚
â”œâ”€â”€ ModSDK/                     # ç‹¬ç«‹å¼€å‘SDK
â”‚   â”œâ”€â”€ SDK/
â”‚   â”œâ”€â”€ Tools/
â”‚   â””â”€â”€ Templates/
â”‚
â”œâ”€â”€ MyMods/                     # æ¨¡ç»„å¼€å‘é¡¹ç›®
â”‚   â”œâ”€â”€ ButtonMod/
â”‚   â””â”€â”€ RobotMod/
â”‚
â””â”€â”€ UnityGameProject/           # Unityé¡¹ç›®
    â””â”€â”€ Assets/
        â””â”€â”€ ModSystem/
            â”œâ”€â”€ Core/Assemblies/ # Core DLLä½ç½®
            â””â”€â”€ Unity/           # Unityç‰¹å®šä»£ç 
```

## 9. å®‰å…¨æ€§å’Œæƒé™

### 9.1 SecurityManagerä½ç½®

- åº”è¯¥åœ¨Coreä¸­ï¼ˆå¹³å°æ— å…³çš„å®‰å…¨é€»è¾‘ï¼‰
- Unityç‰¹å®šçš„å®‰å…¨å®ç°æ”¾åœ¨Unityå±‚

## 10. æ€»ç»“

ä¸»è¦æ”¹è¿›ç‚¹ï¼š
1. **ä¸¥æ ¼åˆ†ç¦»Coreå’ŒUnityä»£ç **
2. **ä½¿ç”¨ä¾èµ–æ³¨å…¥è§£å†³å¹³å°ä¾èµ–**
3. **é¿å…é‡å¤åˆå§‹åŒ–**
4. **ä½¿ç”¨æ¨¡æ¿ç³»ç»Ÿæ›¿ä»£ç¡¬ç¼–ç **
5. **é‡ç»„æ–‡æ¡£ç»“æ„**
6. **æ˜ç¡®æ–‡ä»¶å¼€å‘ç¯å¢ƒ**
7. **å®Œå–„é¡¹ç›®ç»“æ„è¯´æ˜**

è¿™äº›æ”¹è¿›å°†ä½¿ç³»ç»Ÿï¼š
- çœŸæ­£å®ç°å¹³å°æ— å…³çš„Core
- æ”¯æŒç‹¬ç«‹æ¨¡ç»„å¼€å‘
- æ¶æ„æ›´æ¸…æ™°
- æ–‡æ¡£æ›´æ˜“ç†è§£
- æ‰©å±•æ€§æ›´å¼º